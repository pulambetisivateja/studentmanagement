trigger:
  - master

pool:
  name: azure-vm-pool   # Self-hosted agent pool

variables:
  jarName: 'studentmanagement-0.0.1-SNAPSHOT.jar'
  appPath: '/home/azureuser/app'

steps:

  # ===============================
  # STEP 1 - Build JAR
  # ===============================
  - script: |
      chmod +x mvnw
      ./mvnw clean package -DskipTests
    displayName: 'Build Spring Boot JAR'

  # ===============================
  # STEP 2 - Prepare Deploy Folder
  # ===============================
  - script: |
      mkdir -p $(appPath)
    displayName: 'Create Deploy Folder'

  # ===============================
  # STEP 3 - Stop Old Application
  # ===============================
  - script: |
      pkill -f $(jarName) || true
    displayName: 'Stop Old Application'

  # ===============================
  # STEP 4 - Deploy New JAR
  # ===============================
  - script: |
      cp target/$(jarName) $(appPath)/
    displayName: 'Copy JAR to Deploy Folder'

  # ===============================
  # STEP 5 - Start Application
  # ===============================
  - script: |
      cd $(appPath)
      echo "Starting Spring Boot application..."
      nohup java -jar $(jarName) > app.log 2>&1 &
      sleep 10
      echo "Checking if app is running..."
      ps -ef | grep $(jarName) || true
      curl http://localhost:8080 || true
    displayName: 'Start Application & Verify'