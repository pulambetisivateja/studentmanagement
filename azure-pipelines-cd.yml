trigger: none  # CD is usually triggered manually or after CI artifact

pool:
  name: Default

steps:
  # 1️⃣ Ensure deployment folder exists on VM
  - task: SSH@0
    displayName: "Create deployment folder on VM"
    inputs:
      sshEndpoint: 'Spring_Boot_app'
      service_connect_name: 'Spring_Boot_app'
      runOptions: 'commands'
      commands: |
        mkdir -p /home/azureuser/myapp
        echo "Deployment folder ready."

  # 2️⃣ Copy JAR from CI artifact to VM
  - task: CopyFilesOverSSH@0
    displayName: "Copy JAR to VM"
    inputs:
      sshEndpoint: 'Spring_Boot_app'
      service_connect_name: 'Spring_Boot_app'
      sourceFolder: '$(System.DefaultWorkingDirectory)/target'
      contents: '**/*.jar'
      targetFolder: '/home/azureuser/myapp'
      cleanTargetFolder: false

  # 3️⃣ Run the Spring Boot app in background
  - task: SSH@0
    displayName: "Run Spring Boot app in background"
    inputs:
      sshEndpoint: 'Spring_Boot_app1'
      service_connect_name: 'Spring_Boot_app'
      runOptions: 'commands'
      commands: |
        cd /home/azureuser/myapp
        JAR_FILE=$(ls *.jar | head -n 1)
        nohup java -jar "$JAR_FILE" > app.log 2>&1 &
        echo "App started in background with PID: $!"

  # 4️⃣ Optional: Tail the log for confirmation
  - task: SSH@0
    displayName: "Tail app.log for last 20 lines"
    inputs:
      sshEndpoint: 'Spring_Boot_app'
      service_connect_name: 'Spring_Boot_app1'
      runOptions: 'commands'
      commands: |
        cd /home/azureuser/myapp
        echo "Last 20 lines of app.log:"
        tail -n 20 app.log